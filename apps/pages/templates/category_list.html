{% extends 'base.html' %}

{% block title %}Produtos por Categoria{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="d-flex flex-wrap align-items-end gap-3 mb-4">
            <h1 class="mb-0 me-4">Nossos Produtos</h1>
            <form method="get" class="d-flex gap-3 align-items-end flex-wrap">
                <div>
                    <label for="category" class="form-label">Categoria:</label>
                    <select name="category" id="category" class="form-select">
                        <option value="">Todas</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:'s' %}selected{% endif %}>{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="search" class="form-label">Buscar produto:</label>
                    <input type="text" name="search" id="search" class="form-control" value="{{ request.GET.search }}" placeholder="Digite o nome do produto">
                </div>
                <button type="submit" class="btn btn-primary">Filtrar</button>
            </form>
        </div>

        {% for category in categories %}
        <div class="category-section mt-4 mb-5">
            <h2 class="mb-3">{{ category.name }}</h2>
            {% if category.products.exists %}
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
                    {% for product in category.active_products %}
                        {% if product.stock > 0 %}
                            <div class="col">
                                <form method="post" action="{% url 'cart' %}" class="card h-100">
                                    {% csrf_token %}
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.title }}">
                                    {% else %}
                                    <img src="https://via.placeholder.com/300x200" class="card-img-top" alt="Sem imagem">
                                    {% endif %}
                                    <h5 class="card-title">{{ product.title }}</h5>
                                    <p class="card-text">{{ product.description|truncatechars:100 }}</p>
                                    <p class="card-text">{{ product.referencia|truncatechars:40 }}</p>
                                    <div class="d-flex gap-2 mt-auto justify-content-center">
                                        <p class="mb-0"><strong>R$ {{ product.price|floatformat:2 }}</strong></p>
                                        {% if product.price2 > 0 %}
                                            <div class="d-flex flex-column align-items-center">
                                                <span class="fw-bold text-danger" style="font-size: 0.9rem;">Promoção</span>
                                                <p class="mb-0"><strong class="text-danger">R$ {{ product.price2|floatformat:2 }}</strong></p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex gap-2 mt-auto justify-content-center">
                                        <span class="fw-bold">Estoque: {{ product.stock }}</span>
                                        <span>Qtde:</span>
                                        <input type="number" name="qtde" min="1" max="{{ product.stock }}" value="1" class="form-control form-control-sm" style="width: 70px;" placeholder="Qtde">
                                        <input type="hidden" name="product_id" value="{{ product.id }}">
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-2">Comprar</button>
                                </form>
                            </div>
                        {% endif %}
                     {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">Nenhum produto disponível nesta categoria.</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% endblock %}